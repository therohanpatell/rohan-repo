<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Zero â€“ Unified AI Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0b1020;
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.18);
      --accent-strong: #22c55e;
      --danger: #f97373;
      --text: #f9fafb;
      --muted: #c7d2fe;
      --border: #1f2937;
      --card-radius: clamp(14px, 1vw, 22px);
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.85);
      --transition: 0.2s ease-in-out;
      
      /* Dynamic font sizes based on viewport */
      --font-title: clamp(28px, 2.5vw, 48px);
      --font-subtitle: clamp(16px, 1.2vw, 24px);
      --font-question: clamp(18px, 1.4vw, 28px);
      --font-option: clamp(16px, 1.2vw, 22px);
      --font-label: clamp(14px, 1vw, 20px);
      --font-small: clamp(12px, 0.9vw, 18px);
      --font-card-title: clamp(18px, 1.4vw, 26px);
      --font-world-btn: clamp(16px, 1.2vw, 22px);
      
      /* Dynamic spacing */
      --spacing-xs: clamp(4px, 0.4vw, 8px);
      --spacing-sm: clamp(8px, 0.6vw, 12px);
      --spacing-md: clamp(12px, 0.8vw, 18px);
      --spacing-lg: clamp(16px, 1vw, 24px);
      --spacing-xl: clamp(20px, 1.2vw, 32px);
    }

    * {
      box-sizing: border-box;
    }

    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); }
      50% { box-shadow: 0 0 40px rgba(74, 222, 128, 0.8); }
    }

    @keyframes slide-in {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }

    @keyframes shake-screen {
      0%, 100% { transform: translate(0, 0); }
      10%, 30%, 50%, 70%, 90% { transform: translate(-2px, 2px); }
      20%, 40%, 60%, 80% { transform: translate(2px, -2px); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes rotate-glow {
      0% { transform: rotate(0deg); filter: hue-rotate(0deg); }
      100% { transform: rotate(360deg); filter: hue-rotate(360deg); }
    }

    @keyframes scale-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes slide-up {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes glow-border {
      0%, 100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); }
      50% { box-shadow: 0 0 40px rgba(74, 222, 128, 0.8), 0 0 60px rgba(74, 222, 128, 0.6); }
    }

    @keyframes text-shimmer {
      0% { background-position: -100% 0; }
      100% { background-position: 200% 0; }
    }

    .shake-animation {
      animation: shake 0.5s ease;
    }

    .bounce-animation {
      animation: bounce 0.6s ease;
    }

    .slide-up-animation {
      animation: slide-up 0.5s ease;
    }

    .scale-pulse-animation {
      animation: scale-pulse 0.8s ease infinite;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 25%, #312e81 50%, #1e1b4b 75%, #0f172a 100%);
      background-size: 400% 400%;
      animation: gradient-shift 15s ease infinite;
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-shell {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100vh;
      overflow: hidden;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 16px;
      border: 2px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top left, #111827 0, #020617 45%);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(74, 222, 128, 0.05), transparent);
      pointer-events: none;
      z-index: 0;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-block h1 {
      margin: 0;
      font-size: var(--font-title);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: linear-gradient(90deg, #4ade80, #a78bfa, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 1;
    }

    .title-sub {
      font-size: var(--font-subtitle);
      color: var(--muted);
      font-weight: 500;
    }

    .pill-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      font-size: var(--font-label);
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: 999px;
      border: clamp(1px, 0.15vw, 2px) solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-weight: 600;
    }

    .pill span.dot {
      width: clamp(12px, 1vw, 18px);
      height: clamp(12px, 1vw, 18px);
      border-radius: 999px;
      background: radial-gradient(circle, var(--accent-strong), #16a34a);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.85);
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .score-chip {
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: clamp(1px, 0.15vw, 2px) solid rgba(148, 163, 184, 0.7);
      font-size: var(--font-subtitle);
      display: inline-flex;
      gap: var(--spacing-sm);
      align-items: center;
      font-weight: 700;
    }

    .score-chip strong {
      color: var(--accent-strong);
      font-weight: 800;
      font-size: clamp(20px, 1.6vw, 32px);
    }

    .progress-bar-shell {
      width: 180px;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    .progress-bar-inner {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #a855f7);
      transition: width 0.5s ease-out;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
      gap: 14px;
      flex: 1;
      overflow: hidden;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      .meta {
        align-items: flex-start;
      }
    }

    .worlds-panel {
      border-radius: var(--card-radius);
      background: rgba(15, 23, 42, 0.94);
      border: 2px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: calc(100vh - 180px);
    }

    .worlds-panel::-webkit-scrollbar {
      width: 8px;
    }

    .worlds-panel::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }

    .worlds-panel::-webkit-scrollbar-thumb {
      background: rgba(74, 222, 128, 0.5);
      border-radius: 4px;
    }

    .worlds-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(74, 222, 128, 0.7);
    }

    .worlds-panel h2 {
      margin: 0;
      font-size: var(--font-label);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #a5b4fc;
      font-weight: 800;
      position: relative;
      z-index: 1;
    }

    .world-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .world-btn {
      width: 100%;
      border-radius: var(--card-radius);
      border: clamp(1px, 0.15vw, 2px) solid var(--border);
      padding: var(--spacing-md) var(--spacing-md);
      background: radial-gradient(circle at left, #020617 0, #020617 60%, #020617 100%);
      font-size: var(--font-world-btn);
      color: var(--text);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      cursor: pointer;
      text-align: left;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .world-btn::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at left, rgba(34, 197, 94, 0.1), transparent);
      opacity: 0;
      transition: var(--transition);
      pointer-events: none;
    }

    .world-btn:hover {
      transform: translateY(-3px) scale(1.02);
      border-color: rgba(148, 163, 184, 0.9);
      box-shadow: 0 10px 30px rgba(74, 222, 128, 0.3);
    }

    .world-btn:hover::before {
      opacity: 1;
    }

    .world-btn.active {
      border-color: var(--accent-strong);
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
      background: radial-gradient(circle at left, rgba(34, 197, 94, 0.25), #020617);
      transform: scale(1.05);
    }

    .world-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .world-name {
      font-weight: 600;
    }

    .world-tagline {
      font-size: var(--font-small);
      color: var(--muted);
      font-weight: 500;
    }

    .world-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .world-status.completed {
      color: #bbf7d0;
      border-color: var(--accent-strong);
      background: rgba(34, 197, 94, 0.16);
    }

    .world-status.current {
      color: #e0f2fe;
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.15);
    }

    .world-main {
      border-radius: var(--card-radius);
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.18), #020617 55%, #020617);
      border: 2px solid rgba(148, 163, 184, 0.5);
      box-shadow: var(--shadow-soft);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: calc(100vh - 180px);
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .world-main::-webkit-scrollbar {
      width: 8px;
    }

    .world-main::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }

    .world-main::-webkit-scrollbar-thumb {
      background: rgba(74, 222, 128, 0.5);
      border-radius: 4px;
    }

    .world-main::-webkit-scrollbar-thumb:hover {
      background: rgba(74, 222, 128, 0.7);
    }

    .world-main::before {
      content: "";
      position: fixed;
      inset: -40%;
      background:
        radial-gradient(circle at 15% 0, rgba(244, 114, 182, 0.14), transparent 55%),
        radial-gradient(circle at 85% 0, rgba(56, 189, 248, 0.2), transparent 55%);
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
    }

    .world-main > * {
      position: relative;
      z-index: 1;
    }

    .world-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .world-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .world-header h2 {
      margin: 0;
      font-size: clamp(24px, 2vw, 40px);
      font-weight: 800;
      background: linear-gradient(90deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .world-caption {
      font-size: var(--font-label);
      color: var(--muted);
      font-weight: 500;
    }

    .world-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .badge {
      font-size: var(--font-small);
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: 999px;
      border: clamp(1px, 0.15vw, 2px) solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      font-weight: 700;
    }

    .badge.accent {
      border-color: var(--accent-strong);
      color: #bbf7d0;
      background: var(--accent-soft);
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
    }

    .card {
      border-radius: var(--card-radius);
      border: clamp(1px, 0.15vw, 2px) solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.96);
      padding: var(--spacing-lg) var(--spacing-xl);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      animation: none;
    }
    
    .card.initial-load {
      animation: slide-up 0.5s ease;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .card-title {
      font-size: var(--font-card-title);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #a5b4fc;
      font-weight: 800;
    }

    .card-sub {
      font-size: var(--font-label);
      color: var(--muted);
      font-weight: 500;
    }

    .question-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
      flex: 1;
    }

    .question-text {
      font-size: var(--font-question);
      line-height: 1.5;
      font-weight: 600;
      color: #e0e7ff;
      min-height: clamp(50px, 4vh, 80px);
      max-height: clamp(80px, 8vh, 120px);
      overflow-y: auto;
      display: flex;
      align-items: center;
    }

    .help-text {
      font-size: var(--font-small);
      color: var(--muted);
      font-weight: 500;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .options-list .option-btn {
      animation: none;
    }
    
    .options-list.initial-load .option-btn {
      animation: slide-up 0.4s ease;
      animation-fill-mode: both;
    }

    .options-list.initial-load .option-btn:nth-child(1) { animation-delay: 0.1s; }
    .options-list.initial-load .option-btn:nth-child(2) { animation-delay: 0.2s; }
    .options-list.initial-load .option-btn:nth-child(3) { animation-delay: 0.3s; }
    .options-list.initial-load .option-btn:nth-child(4) { animation-delay: 0.4s; }

    .option-btn {
      border-radius: var(--card-radius);
      padding: var(--spacing-md) var(--spacing-lg);
      border: clamp(2px, 0.2vw, 3px) solid rgba(30, 64, 175, 0.8);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: var(--font-option);
      text-align: left;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
      font-weight: 600;
      min-height: clamp(60px, 5vh, 90px);
    }
    
    .option-btn > div {
      flex: 1;
      line-height: 1.4;
    }

    .option-btn:hover {
      border-color: var(--accent-strong);
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 10px 40px rgba(74, 222, 128, 0.4);
      background: rgba(34, 197, 94, 0.1);
    }

    .option-label {
      font-size: var(--font-label);
      color: var(--muted);
      margin-right: var(--spacing-xs);
      font-weight: 700;
    }

    .pill-small {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: var(--font-small);
      padding: var(--spacing-xs) var(--spacing-sm);
      color: var(--muted);
      font-weight: 600;
    }

    .state-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--font-small);
      color: var(--muted);
      gap: var(--spacing-xs);
      margin-top: auto;
      font-weight: 600;
    }

    .state-left,
    .state-right {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .timer {
      font-variant-numeric: tabular-nums;
    }

    .locks-row {
      display: flex;
      gap: 6px;
    }

    .lock-pill {
      width: 16px;
      height: 16px;
      border-radius: 5px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      position: relative;
      overflow: hidden;
    }

    .lock-pill.completed {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
    }

    .lock-pill.completed::after {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: 3px;
      background: linear-gradient(135deg, var(--accent-strong), #a855f7);
    }

    .lock-pill.current {
      border-style: dashed;
      border-color: #38bdf8;
    }

    .feedback {
      font-size: var(--font-option);
      margin-top: var(--spacing-xs);
      font-weight: 700;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--card-radius);
      animation: bounce 0.6s ease;
    }

    .feedback.positive {
      color: #bbf7d0;
      background: rgba(34, 197, 94, 0.15);
      border: clamp(1px, 0.15vw, 2px) solid rgba(34, 197, 94, 0.5);
    }

    .feedback.negative {
      color: #fecaca;
      background: rgba(239, 68, 68, 0.15);
      border: clamp(1px, 0.15vw, 2px) solid rgba(239, 68, 68, 0.5);
    }

    .primary-btn,
    .secondary-btn,
    .ghost-btn {
      border-radius: 999px;
      font-size: var(--font-label);
      padding: var(--spacing-md) var(--spacing-xl);
      border: clamp(1px, 0.15vw, 2px) solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: all 0.3s ease;
      font-weight: 700;
    }

    .primary-btn {
      border-color: var(--accent-strong);
      background: linear-gradient(90deg, #22c55e, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 800;
      box-shadow: 0 12px 30px rgba(22, 163, 74, 0.5);
    }

    .primary-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 20px 50px rgba(22, 163, 74, 0.7);
    }

    .secondary-btn:hover,
    .ghost-btn:hover {
      transform: translateY(-1px);
      border-color: var(--accent-strong);
    }

    .ghost-btn {
      background: transparent;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 13px;
      padding: 6px 8px;
      resize: vertical;
      outline: none;
    }

    textarea:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .mini-visual {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip {
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      padding: 2px 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .hash-row {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.96);
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      overflow-x: auto;
      white-space: nowrap;
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .hint {
      font-size: 11px;
      color: #e5e7eb;
    }

    .hint span {
      color: var(--accent-strong);
    }

    .divider {
      height: 1px;
      background: radial-gradient(circle, rgba(148, 163, 184, 0.4), transparent);
      margin: 4px -6px;
    }

    .small-label {
      font-size: var(--font-small);
      color: var(--muted);
      font-weight: 600;
    }

    /* WIN MODAL â€“ 3 WORLDS CLEARED */
    .win-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 999;
    }

    .win-modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .win-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      backdrop-filter: blur(12px);
    }

    .win-modal-content {
      position: relative;
      border-radius: 22px;
      border: 3px solid rgba(74, 222, 128, 0.9);
      background: radial-gradient(circle at top, rgba(74, 222, 128, 0.25), #020617);
      padding: 32px 28px 24px;
      box-shadow: 0 24px 60px rgba(22, 163, 74, 0.8), 0 0 100px rgba(74, 222, 128, 0.5);
      max-width: 500px;
      width: 90%;
      text-align: center;
      animation: pop-in 0.4s ease-out;
    }

    .win-title {
      font-size: 48px;
      font-weight: 900;
      margin-bottom: 12px;
      background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 3s ease infinite;
    }

    .win-body {
      font-size: 24px;
      color: var(--muted);
      margin-bottom: 24px;
      font-weight: 600;
    }

    .win-confetti {
      position: absolute;
      inset: -40px;
      pointer-events: none;
      background:
        radial-gradient(circle at 10% 20%, rgba(239, 68, 68, 0.24), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(59, 130, 246, 0.3), transparent 55%),
        radial-gradient(circle at 20% 90%, rgba(234, 179, 8, 0.26), transparent 55%);
      opacity: 0.6;
      mix-blend-mode: screen;
    }

    @keyframes pop-in {
      0% {
        transform: translateY(10px) scale(0.96);
        opacity: 0;
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* SCORE POPUP NOTIFICATION */
    .score-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      z-index: 1000;
      padding: 24px 32px;
      border-radius: 20px;
      font-size: clamp(24px, 2vw, 36px);
      font-weight: 800;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      pointer-events: none;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .score-popup.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .score-popup.positive {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
      color: #fff;
      border: 3px solid #bbf7d0;
    }

    .score-popup.negative {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
      color: #fff;
      border: 3px solid #fecaca;
    }

    .score-popup-value {
      display: block;
      font-size: clamp(32px, 3vw, 48px);
      margin-top: 8px;
    }

    .option-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <h1>Agent Zero: Digital Recovery Suite</h1>
      <div class="title-sub">Master AI, ML, and Data Engineering Challenges</div>
      <div class="pill-row">
        <div class="pill">
          <span class="dot"></span>
          Live session Â· <span id="world-counter-label">World 1 of 8</span>
        </div>
        <div class="pill">
          Mode: <strong>Solo</strong> Â· Difficulty: Adaptive
        </div>
      </div>
    </div>
    <div class="meta">
      <div class="score-chip">
        SCORE: <strong id="score-display">0</strong>
        <span style="width:1px;height:14px;background:#1f2937;"></span>
        Cleared: <span id="cleared-worlds-count">0</span>/3 to win
      </div>
      <div class="progress-bar-shell">
        <div id="progress-bar-inner" class="progress-bar-inner"></div>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: WORLD SELECTOR -->
    <aside class="worlds-panel">
      <h2>World Map</h2>
      <div class="world-grid" id="world-grid">
        <!-- buttons are created by JS to keep state synced -->
      </div>
    </aside>

    <!-- RIGHT: ACTIVE WORLD CONTENT -->
    <section class="world-main">
      <div class="world-header">
        <div class="world-header-left">
          <h2 id="world-title">AI Escape Room</h2>
          <div id="world-caption" class="world-caption">
            Unlock corrupted doors by answering core AI questions under time pressure.
          </div>
        </div>
        <div class="world-badges">
          <span class="badge accent" id="world-badge-primary">AI Fundamentals</span>
          <span class="badge" id="world-badge-secondary">Timed Â· Scenario-based</span>
        </div>
      </div>

      <div class="content-grid" id="world-content">
        <!-- Each world injects its own markup -->
      </div>
    </section>
  </main>
</div>

<!-- SCORE POPUP NOTIFICATION -->
<div id="score-popup" class="score-popup">
  <div id="score-popup-text"></div>
  <span id="score-popup-value" class="score-popup-value"></span>
</div>

<!-- WIN MODAL â€“ FIRES AFTER ANY 3 WORLDS CLEARED -->
<div id="win-modal" class="win-modal">
  <div class="win-modal-backdrop"></div>
  <div class="win-modal-content">
    <div class="win-confetti"></div>
    <div class="win-title">ðŸŽ‰ Mission Accomplished!</div>
    <div class="win-body">
      Youâ€™ve successfully cleared 3 rooms.<br/>
      Final Score: <span id="final-score-display">0</span><br/>
      The system will reset with fresh questions for the next player.
    </div>
    <button id="win-reset-btn" class="primary-btn">Start New Session</button>
  </div>
</div>

<script>
  /****************************************************
   * GLOBAL STATE
   ****************************************************/
  const appState = {
    score: 0,
    currentWorldId: "escape",
    gameWon: false,
    worlds: {
      escape: { id: "escape", name: "AI Escape Room", completed: false },
      mlbuilder: { id: "mlbuilder", name: "ML Model Builder", completed: false },
      prompt: { id: "prompt", name: "GenAI Prompt Arena", completed: false },
      chain: { id: "chain", name: "Blockchain Hash Hunt", completed: false },
      clean: { id: "clean", name: "Data Cleaning Ninja", completed: false },
      schema: { id: "schema", name: "Schema Validator Lab", completed: false },
      query: { id: "query", name: "Query Optimizer Race", completed: false },
      crypto: { id: "crypto", name: "Crypto-for-Data Puzzle", completed: false },
    },
    timers: {
      escape: { secondsLeft: 45, intervalId: null },
    },
    csvQuestions: {}, // Will store questions loaded from CSV
  };

  /****************************************************
   * CSV LOADER - Load questions from CSV file
   ****************************************************/
  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  }

  async function loadQuestionsFromCSV() {
    try {
      const response = await fetch('ALL_QUESTIONS_MASTER.csv');
      const csvText = await response.text();
      const lines = csvText.split('\n').slice(1); // Skip header
      
      const worldMap = {
        'AI Escape Room': 'escape',
        'ML Model Builder': 'mlbuilder',
        'GenAI Prompt Arena': 'prompt',
        'Blockchain Hash Hunt': 'chain',
        'Data Cleaning Ninja': 'clean',
        'Schema Validator Lab': 'schema',
        'Query Optimizer Race': 'query',
        'Crypto-for-Data Puzzle': 'crypto'
      };
      
      lines.forEach(line => {
        if (!line.trim()) return;
        
        const parts = parseCSVLine(line);
        if (parts.length < 9) return;
        
        const worldName = parts[0];
        const worldId = worldMap[worldName];
        if (!worldId) return;
        
        const question = parts[2];
        const optionA = parts[3];
        const optionB = parts[4];
        const optionC = parts[5];
        const optionD = parts[6];
        const correctAnswer = parts[7];
        const difficulty = parts[8].trim().toLowerCase();
        
        const correctIndex = {'a': 0, 'b': 1, 'c': 2, 'd': 3}[correctAnswer.toLowerCase()] || 0;
        
        if (!appState.csvQuestions[worldId]) {
          appState.csvQuestions[worldId] = [];
        }
        
        appState.csvQuestions[worldId].push({
          question: question,
          options: [optionA, optionB, optionC, optionD],
          correctIndex: correctIndex,
          difficulty: difficulty,
          positive: "âœ… Correct! Great job!",
          negative: "âŒ Not quite right. Try again!",
        });
      });
      
      console.log('âœ… Questions loaded from CSV successfully!');
      Object.keys(appState.csvQuestions).forEach(world => {
        console.log(`  ${world}: ${appState.csvQuestions[world].length} questions`);
      });
    } catch (error) {
      console.error('âŒ Error loading CSV:', error);
      console.log('Using embedded questions as fallback');
    }
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function getClearedWorldsCount() {
    return Object.values(appState.worlds).filter(w => w.completed).length;
  }

  function getDifficultyLevel() {
    const cleared = getClearedWorldsCount();
    if (cleared < 2) return "easy"; // 0â€“1 worlds: easier onboarding
    return "hard";                  // 2+ worlds: ramp up difficulty
  }

  function updateGlobalHUD() {
    document.getElementById("score-display").textContent = appState.score;
    const cleared = getClearedWorldsCount();
    document.getElementById("cleared-worlds-count").textContent = cleared;
    const progressPercent = (cleared / 3) * 100;
    document.getElementById("progress-bar-inner").style.width = progressPercent + "%";

    const worldOrder = [
      "escape","mlbuilder","prompt","chain","clean","schema","query","crypto"
    ];
    const index = worldOrder.indexOf(appState.currentWorldId);
    document.getElementById("world-counter-label").textContent =
      "World " + (index + 1) + " of 8";
  }

function showScorePopup(points, isPositive) {
  const popup = document.getElementById("score-popup");
  const text = document.getElementById("score-popup-text");
  const value = document.getElementById("score-popup-value");
  
  if (!popup || !text || !value) return;
  
  // Aesthetic copy
  text.textContent = isPositive ? "Score boosted" : "Score reduced";
  const absPoints = Math.abs(points);
  value.textContent = (isPositive ? "+" : "âˆ’") + absPoints + " pts";
  
  // Set style
  popup.className = "score-popup " + (isPositive ? "positive" : "negative");
  
  // Show popup
  setTimeout(() => popup.classList.add("show"), 10);
  
  // Hide after 1.5 seconds
  setTimeout(() => {
    popup.classList.remove("show");
  }, 1500);
}

  function showWinModal() {
    const modal = document.getElementById("win-modal");
    const finalScoreDisplay = document.getElementById("final-score-display");
    if (!modal) return;
    
    // Update final score
    if (finalScoreDisplay) {
      finalScoreDisplay.textContent = appState.score;
    }
    
    modal.classList.add("active");
  }

  function hideWinModal() {
    const modal = document.getElementById("win-modal");
    if (!modal) return;
    modal.classList.remove("active");
  }

  function checkGlobalWin() {
    const cleared = getClearedWorldsCount();
    if (cleared >= 3 && !appState.gameWon) {
      playSound('win');
      appState.gameWon = true;
      showWinModal();
    }
  }

  /****************************************************
   * WORLD SELECTOR WIDGET
   ****************************************************/
  const worldDefinitions = [
    {
      id: "escape",
      label: "AI Escape Room",
      subtitle: "Clear timed knowledge locks.",
    },
    {
      id: "mlbuilder",
      label: "ML Model Builder",
      subtitle: "Design, tune, and debug a model pipeline.",
    },
    {
      id: "prompt",
      label: "GenAI Prompt Arena",
      subtitle: "Optimize prompts and mitigate hallucinations.",
    },
    {
      id: "chain",
      label: "Blockchain Hash Hunt",
      subtitle: "Locate hashes and validate blocks.",
    },
    {
      id: "clean",
      label: "Data Cleaning Ninja",
      subtitle: "Normalize, dedupe, and repair datasets.",
    },
    {
      id: "schema",
      label: "Schema Validator Lab",
      subtitle: "Catch schema drift before prod does.",
    },
    {
      id: "query",
      label: "Query Optimizer Race",
      subtitle: "Pick the faster plan under pressure.",
    },
    {
      id: "crypto",
      label: "Crypto-for-Data Puzzle",
      subtitle: "Decrypt, compare keys, and secure data.",
    },
  ];

  function buildWorldButtons() {
    const grid = document.getElementById("world-grid");
    grid.innerHTML = "";
    worldDefinitions.forEach((w, idx) => {
      const btn = document.createElement("button");
      btn.className = "world-btn";
      if (w.id === appState.currentWorldId) btn.classList.add("active");
      btn.dataset.worldId = w.id;

      const status = document.createElement("div");
      status.className = "world-status";
      const meta = appState.worlds[w.id];
      if (meta.completed) {
        status.textContent = "Cleared";
        status.classList.add("completed");
      } else if (w.id === appState.currentWorldId) {
        status.textContent = "In progress";
        status.classList.add("current");
      } else {
        status.textContent = "Locked in scope";
      }

      btn.innerHTML = `
        <div class="world-name-row">
          <div class="world-name">${idx + 1}. ${w.label}</div>
        </div>
        <div class="world-tagline">${w.subtitle}</div>
      `;
      btn.querySelector(".world-name-row").appendChild(status);

      btn.addEventListener("click", () => moveToWorld(w.id));
      grid.appendChild(btn);
    });
  }

  function markWorldButtonActive(worldId) {
    document.querySelectorAll(".world-btn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.worldId === worldId);
      const status = btn.querySelector(".world-status");
      const meta = appState.worlds[btn.dataset.worldId];
      status.classList.remove("current","completed");
      if (meta.completed) {
        status.textContent = "Cleared";
        status.classList.add("completed");
      } else if (btn.dataset.worldId === worldId) {
        status.textContent = "In progress";
        status.classList.add("current");
      } else {
        status.textContent = "Locked in scope";
      }
    });
  }

  /****************************************************
   * QUESTION BANKS â€“ TAGGED WITH DIFFICULTY
   * (Extend up to 50 per world as needed)
   ****************************************************/

  /*********** 1. AI ESCAPE ROOM ***********/
  const escapeQuestions = [
    {
      question: "What is a transformer in modern AI?",
      options: [
        "A neural architecture using self-attention to process sequences in parallel.",
        "A model that only works for images using convolution layers.",
        "A simple rule-based system for if/else logic.",
        "A hardware chip used exclusively in robotics.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
    {
      question: "What is Retrieval-Augmented Generation (RAG)?",
      options: [
        "Using generative models to compress images.",
        "Combining an LLM with external retrieval of documents for better answers.",
        "Training a model only once and freezing it.",
        "A cryptographic protocol for secure hashing.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is an AI hallucination?",
      options: [
        "GPU overclocking issue.",
        "Model producing confident but factually wrong or fabricated outputs.",
        "When a model refuses to answer.",
        "Noise in sensor data.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is multimodal AI?",
      options: [
        "AI that only works for text data.",
        "AI that can consume and reason over multiple input types (text, image, audio, video).",
        "AI that runs on multiple GPUs.",
        "AI that can speak multiple human languages only.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is fine-tuning in machine learning?",
      options: [
        "Adjusting hyperparameters before training.",
        "Training a pre-trained model on a specific task or dataset.",
        "Removing outliers from data.",
        "Compressing a model to reduce size.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of attention mechanisms in neural networks?",
      options: [
        "To reduce model size.",
        "To allow models to focus on relevant parts of input data.",
        "To speed up training time.",
        "To prevent overfitting.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is zero-shot learning?",
      options: [
        "Training a model with zero data points.",
        "A model performing tasks it wasn't explicitly trained on.",
        "Setting all weights to zero.",
        "Training without a validation set.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is the difference between supervised and unsupervised learning?",
      options: [
        "Supervised uses labeled data, unsupervised finds patterns in unlabeled data.",
        "Supervised is faster than unsupervised.",
        "Unsupervised requires more compute power.",
        "There is no difference.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
    {
      question: "What is a neural network activation function?",
      options: [
        "A function that starts the training process.",
        "A function that introduces non-linearity to help learn complex patterns.",
        "A function that saves model weights.",
        "A function that loads training data.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is transfer learning?",
      options: [
        "Moving data between servers.",
        "Using knowledge from one task to improve performance on another task.",
        "Transferring model ownership.",
        "Converting models between frameworks.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the vanishing gradient problem?",
      options: [
        "When gradients become too small during backpropagation, hindering learning.",
        "When the model runs out of memory.",
        "When training data disappears.",
        "When the learning rate is too high.",
      ],
      correctIndex: 0,
      difficulty: "hard",
    },
    {
      question: "What is batch normalization?",
      options: [
        "Processing data in batches.",
        "A technique to normalize layer inputs to stabilize and speed up training.",
        "Removing bad data samples.",
        "Grouping similar data together.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is the purpose of dropout in neural networks?",
      options: [
        "To remove bad training examples.",
        "To randomly disable neurons during training to prevent overfitting.",
        "To speed up inference.",
        "To reduce model size.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is an embedding in NLP?",
      options: [
        "A way to compress text files.",
        "A dense vector representation of words or tokens in continuous space.",
        "A type of neural network architecture.",
        "A data preprocessing technique.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the difference between precision and recall?",
      options: [
        "Precision is true positives / predicted positives; Recall is true positives / actual positives.",
        "They are the same metric.",
        "Precision measures speed, recall measures accuracy.",
        "Precision is for classification, recall is for regression.",
      ],
      correctIndex: 0,
      difficulty: "hard",
    },
    {
      question: "What is a convolutional neural network (CNN) primarily used for?",
      options: [
        "Text generation.",
        "Image processing and computer vision tasks.",
        "Time series prediction.",
        "Audio synthesis.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is reinforcement learning?",
      options: [
        "Training with extra labeled data.",
        "Learning through trial and error with rewards and penalties.",
        "Repeating training multiple times.",
        "Using multiple models together.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of a loss function?",
      options: [
        "To delete bad data.",
        "To measure how well the model's predictions match the actual values.",
        "To compress the model.",
        "To visualize training progress.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is gradient descent?",
      options: [
        "A method to reduce model size.",
        "An optimization algorithm to minimize the loss function by updating weights.",
        "A way to clean data.",
        "A neural network architecture.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is overfitting?",
      options: [
        "When a model is too large.",
        "When a model learns training data too well and performs poorly on new data.",
        "When training takes too long.",
        "When the model uses too much memory.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is a recurrent neural network (RNN) good for?",
      options: [
        "Image classification.",
        "Sequential data like text or time series.",
        "Static tabular data.",
        "Clustering tasks.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of a validation set?",
      options: [
        "To train the model.",
        "To tune hyperparameters and evaluate model performance during training.",
        "To test the final model.",
        "To store backup data.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is ensemble learning?",
      options: [
        "Training one large model.",
        "Combining multiple models to improve overall performance.",
        "Using multiple GPUs.",
        "Training on multiple datasets.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is the bias-variance tradeoff?",
      options: [
        "Choosing between fast and slow training.",
        "Balancing model simplicity (bias) and complexity (variance) for best generalization.",
        "Deciding between CPU and GPU.",
        "Choosing between supervised and unsupervised learning.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is a GAN (Generative Adversarial Network)?",
      options: [
        "A network for data compression.",
        "Two networks (generator and discriminator) competing to create realistic data.",
        "A type of supervised learning.",
        "A data cleaning algorithm.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is tokenization in NLP?",
      options: [
        "Encrypting text data.",
        "Breaking text into smaller units like words or subwords.",
        "Removing punctuation.",
        "Translating text.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of a learning rate?",
      options: [
        "To control how fast data is loaded.",
        "To control the size of weight updates during training.",
        "To measure model accuracy.",
        "To set the number of epochs.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is cross-validation?",
      options: [
        "Training on multiple datasets.",
        "A technique to assess model performance by splitting data into multiple folds.",
        "Validating data quality.",
        "Comparing different models.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is feature engineering?",
      options: [
        "Building new hardware.",
        "Creating or transforming input features to improve model performance.",
        "Removing features from data.",
        "Visualizing features.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the softmax function used for?",
      options: [
        "To reduce model size.",
        "To convert raw scores into probabilities for multi-class classification.",
        "To normalize input data.",
        "To speed up training.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is data augmentation?",
      options: [
        "Adding more servers.",
        "Creating modified versions of training data to increase dataset size and diversity.",
        "Removing duplicate data.",
        "Compressing data.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of pooling layers in CNNs?",
      options: [
        "To increase image resolution.",
        "To reduce spatial dimensions and computational cost while retaining important features.",
        "To add more layers.",
        "To colorize images.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is early stopping?",
      options: [
        "Ending training manually.",
        "Stopping training when validation performance stops improving to prevent overfitting.",
        "Starting training early.",
        "Reducing the number of epochs.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is a hyperparameter?",
      options: [
        "A parameter learned during training.",
        "A configuration setting set before training (like learning rate or batch size).",
        "A type of neural network.",
        "A data preprocessing step.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the F1 score?",
      options: [
        "The first layer's output.",
        "The harmonic mean of precision and recall.",
        "The training speed metric.",
        "The number of features.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is backpropagation?",
      options: [
        "Moving data backwards.",
        "An algorithm to calculate gradients and update weights by propagating errors backward.",
        "Reversing predictions.",
        "Undoing training.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is a confusion matrix?",
      options: [
        "A matrix that confuses the model.",
        "A table showing true positives, false positives, true negatives, and false negatives.",
        "A type of neural network layer.",
        "A data visualization tool.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of regularization?",
      options: [
        "To make training faster.",
        "To prevent overfitting by adding penalties to the loss function.",
        "To increase model size.",
        "To clean data.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is a pre-trained model?",
      options: [
        "A model that failed training.",
        "A model already trained on a large dataset that can be fine-tuned for specific tasks.",
        "A model without weights.",
        "A model that trains itself.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the difference between AI, ML, and Deep Learning?",
      options: [
        "They are all the same thing.",
        "AI is the broadest concept, ML is a subset of AI, and Deep Learning is a subset of ML.",
        "Deep Learning came first, then ML, then AI.",
        "AI is only for robots.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is model inference?",
      options: [
        "Training a model.",
        "Using a trained model to make predictions on new data.",
        "Evaluating model accuracy.",
        "Saving model weights.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of batch size in training?",
      options: [
        "To set the model size.",
        "To determine how many samples are processed before updating weights.",
        "To control the learning rate.",
        "To set the number of layers.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is a latent space?",
      options: [
        "Empty space in memory.",
        "A compressed representation of data in lower dimensions.",
        "The final output layer.",
        "A type of activation function.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is the purpose of normalization in data preprocessing?",
      options: [
        "To remove data.",
        "To scale features to a similar range for better model performance.",
        "To add more features.",
        "To visualize data.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is a decision tree?",
      options: [
        "A tree-like model that makes decisions based on feature values through branching.",
        "A neural network architecture.",
        "A data structure for storage.",
        "A visualization tool.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
    {
      question: "What is the curse of dimensionality?",
      options: [
        "Having too many dimensions in your office.",
        "As feature dimensions increase, data becomes sparse and models need exponentially more data.",
        "When models are too small.",
        "When training is too fast.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is a random forest?",
      options: [
        "A forest with random trees.",
        "An ensemble of decision trees that vote on predictions.",
        "A single decision tree.",
        "A data cleaning technique.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the purpose of an optimizer in training?",
      options: [
        "To optimize data storage.",
        "To update model weights efficiently to minimize the loss function.",
        "To speed up data loading.",
        "To compress the model.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is prompt engineering?",
      options: [
        "Building hardware for AI.",
        "Crafting effective input prompts to get better outputs from language models.",
        "Engineering training data.",
        "Optimizing model architecture.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "What is the difference between classification and regression?",
      options: [
        "Classification predicts categories, regression predicts continuous values.",
        "They are the same.",
        "Classification is faster.",
        "Regression only works with images.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
    {
      question: "What is model quantization?",
      options: [
        "Counting model parameters.",
        "Reducing model precision (e.g., from 32-bit to 8-bit) to decrease size and increase speed.",
        "Adding more layers.",
        "Training multiple models.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is the attention mechanism's key innovation?",
      options: [
        "It makes models bigger.",
        "It allows models to weigh the importance of different input parts dynamically.",
        "It speeds up training.",
        "It removes the need for data.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    }
  ];

  /*********** 2. ML MODEL BUILDER ***********/
  const mlSteps = [
    {
      id: "missing",
      label: "Handle Missing Values",
      question:
        "Your training dataset has 15% missing values in a numeric column. Whatâ€™s a reasonable first approach?",
      options: [
        "Drop all rows with any missing value.",
        "Impute with median or mean based on distribution.",
        "Replace missing values with zero blindly.",
        "Randomly fill values from another column.",
      ],
      correctIndex: 1,
      positive:
        "Good call. Simple imputation preserves most records and keeps training stable.",
      negative:
        "That decision degrades data quality. The validation dashboard lights up red.",
      difficulty: "easy",
    },
    {
      id: "algo",
      label: "Pick Algorithm",
      question:
        "Youâ€™re predicting churn (yes/no) on a tabular dataset with mixed numeric and categorical features. Baseline model?",
      options: [
        "Linear Regression",
        "K-Means Clustering",
        "Random Forest / Gradient Boosted Trees",
        "PCA",
      ],
      correctIndex: 2,
      positive:
        "Tree-based models are a solid, production-friendly default for tabular classification.",
      negative:
        "That choice misaligns with the problem type. The model fails the initial sanity checks.",
      difficulty: "easy",
    },
    {
      id: "overfit",
      label: "Debug Overfitting",
      question:
        "Train accuracy is 0.99 but validation accuracy is 0.68. Whatâ€™s the most direct mitigation?",
      options: [
        "Increase model complexity further.",
        "Add regularization / early stopping / dropout.",
        "Remove validation split.",
        "Train for many more epochs.",
      ],
      correctIndex: 1,
      positive:
        "Regularization and early stopping reduce variance and stabilize generalization.",
      negative:
        "Noise gets amplified. Monitoring flags overfitting, and stakeholders lose confidence.",
      difficulty: "hard",
    },
    // Extend with more steps up to 50 as needed
  ];

  /*********** 3. GenAI PROMPT ARENA ***********/
  const promptQuestions = [
    {
      type: "mcq",
      title: "Fix the Prompt",
      question:
        'Original: "Write code."\nWhat is the better prompt for a production-ready function?',
      options: [
        'â€œWrite any JavaScript code you want.â€',
        'â€œWrite a Python function named `add` that takes two integers and returns their sum. Include type hints and one usage example.â€',
        'â€œCode please.â€',
        "â€œExplain life in code form.â€",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      type: "mcq",
      title: "Reduce Hallucination",
      question:
        "Which instruction is best to reduce hallucination when asking about niche APIs?",
      options: [
        "â€œIf you donâ€™t know, invent an answer.â€",
        "â€œAlways respond with code only.â€",
        "â€œIf you are not certain, say you are unsure and indicate what documentation I should check.â€",
        "â€œIgnore unspecified details.â€",
      ],
      correctIndex: 2,
      difficulty: "hard",
    },
    {
      type: "mcq",
      title: "Prompt Clarity",
      question:
        "You need an LLM to generate a JSON response. Which prompt structure is most effective?",
      options: [
        '"Give me some JSON data."',
        '"Return a JSON object with keys: name (string), age (number), active (boolean). Example: {\\"name\\":\\"John\\",\\"age\\":30,\\"active\\":true}"',
        '"JSON please."',
        '"Make it look like JSON but don\'t worry about the format."',
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
  ];

  /*********** 4. BLOCKCHAIN HASH HUNT ***********/
  const chainQuestions = [
    {
      question:
        "You see a block whose hash doesnâ€™t match the recomputed hash from its contents. What does that indicate?",
      options: [
        "The block was tampered with or corrupted.",
        "The consensus algorithm changed.",
        "The network is offline.",
        "Hashes are supposed to change randomly all the time.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
    {
      question: "Which consensus mechanism is energy-efficient and common in modern chains?",
      options: [
        "Proof of Work (PoW)",
        "Proof of Stake (PoS)",
        "Proof of Burn",
        "Proof of Noise",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "What is a blockchain nonce?",
      options: [
        "A random number used once in mining to find a valid hash.",
        "The network name.",
        "A type of cryptocurrency wallet.",
        "The block size limit.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
  ];

  /*********** 5. DATA CLEANING NINJA ***********/
  const cleaningQuestions = [
    {
      question: "You see two rows with identical `user_id`, `email`, and `signup_date`.",
      options: [
        "Keep both rows.",
        "Drop one as a duplicate record.",
        "Randomly modify one of the emails.",
        "Delete the entire table.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question: "Dates are in mixed formats: `2025-01-10`, `10/01/2025`, `Jan 10 2025`.",
      options: [
        "Leave them as-is.",
        "Convert all into a single canonical format (e.g., ISO 8601).",
        "Store them as free text forever.",
        "Replace with current timestamp.",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question: "You find email addresses with leading/trailing spaces in your dataset.",
      options: [
        "Leave them as-is for authenticity.",
        "Trim whitespace from all email fields.",
        "Delete all email records.",
        "Add more spaces to make them equal length.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
  ];

  /*********** 6. SCHEMA VALIDATOR LAB ***********/
  const schemaQuestions = [
    {
      question:
        "Schema requires `user_id` (INT, NOT NULL, PK). You see rows with NULL `user_id`. Whatâ€™s the issue?",
      options: [
        "No issue, PKs can be NULL.",
        "Violation of PK and NOT NULL constraint.",
        "Just a formatting concern.",
        "Only a performance warning.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question:
        "Your app reads column `created_at`, but the DB schema changed it to `created_timestamp`. What is this called?",
      options: [
        "Schema drift / breaking change.",
        "Data cleaning.",
        "Index optimization.",
        "Query normalization.",
      ],
      correctIndex: 0,
      difficulty: "hard",
    },
    {
      question:
        "A foreign key constraint fails when inserting data. What's the most likely cause?",
      options: [
        "The referenced record doesn't exist in the parent table.",
        "The table is too large.",
        "The database is offline.",
        "The column name is misspelled in the application.",
      ],
      correctIndex: 0,
      difficulty: "easy",
    },
  ];

  /*********** 7. QUERY OPTIMIZER RACE ***********/
  const queryQuestions = [
    {
      question:
        "Table `orders` has an index on `customer_id`. Which query is likely faster?",
      options: [
        "SELECT * FROM orders WHERE customer_id = 42;",
        "SELECT * FROM orders WHERE amount + 10 > 1000;",
      ],
      correctIndex: 0,
      labels: ["Uses index on customer_id", "Forces full scan"],
      difficulty: "easy",
    },
    {
      question:
        "Youâ€™re joining large `orders` with small `customers`. Which join order is typically better?",
      options: [
        "SELECT * FROM orders o JOIN customers c ON o.customer_id = c.id;",
        "SELECT * FROM customers c JOIN orders o ON o.customer_id = c.id;",
      ],
      correctIndex: 0,
      labels: ["Drive with big table and leverage index", "Not inherently better"],
      difficulty: "hard",
    },
    {
      question:
        "Which SQL operation is generally most expensive?",
      options: [
        "SELECT with indexed WHERE clause",
        "Full table scan with complex JOIN and no indexes",
      ],
      correctIndex: 1,
      labels: ["Fast with index", "Slow without optimization"],
      difficulty: "easy",
    },
  ];

  /*********** 8. CRYPTO-FOR-DATA PUZZLE ***********/
  const cryptoQuestions = [
    {
      question:
        "Which key should remain secret in a standard public-key encryption scheme?",
      options: [
        "Public key",
        "Private key",
        "Both keys must be public",
        "Neither; keys are irrelevant",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
    {
      question:
        "You compute SHA-256 over a file. What property are you primarily using?",
      options: [
        "Reversibility",
        "Collision resistance and integrity checking",
        "Random number generation",
        "Encryption",
      ],
      correctIndex: 1,
      difficulty: "hard",
    },
    {
      question:
        "What is the main purpose of a digital signature?",
      options: [
        "To encrypt data so no one can read it.",
        "To verify authenticity and integrity of a message.",
        "To compress files.",
        "To generate random passwords.",
      ],
      correctIndex: 1,
      difficulty: "easy",
    },
  ];

  const questionBanks = {
    escape: escapeQuestions,
    mlbuilder: mlSteps,
    prompt: promptQuestions,
    chain: chainQuestions,
    clean: cleaningQuestions,
    schema: schemaQuestions,
    query: queryQuestions,
    crypto: cryptoQuestions,
  };

  function generateSessionQuestions(worldId) {
    // Try CSV questions first
    let all = appState.csvQuestions[worldId] || questionBanks[worldId] || [];
    
    // Always shuffle the entire pool first for maximum randomness
    const shuffledAll = shuffle([...all]);
    
    const difficulty = getDifficultyLevel();
    let pool = shuffledAll.filter(q => q.difficulty === difficulty);
    
    // If we don't have enough questions of the target difficulty, add more
    if (pool.length < 3) {
      const extras = shuffledAll.filter(q => !pool.includes(q));
      pool = pool.concat(extras);
    }
    
    // Shuffle again and take exactly 3 questions
    const finalShuffled = shuffle([...pool]);
    return finalShuffled.slice(0, 3);
  }

  /****************************************************
   * WORLD-SPECIFIC STATE
   ****************************************************/

  let escapeState = {
    sessionQuestions: [],
    currentIndex: 0,
    locksCleared: 0,
    totalLocks: 3,
    feedback: "",
    answered: false,
  };

  let mlState = {
    sessionQuestions: [],
    currentIndex: 0,
    failure: false,
    feedback: "",
    answered: false,
  };

  let promptState = {
    sessionQuestions: [],
    currentIndex: 0,
    feedback: "",
    answered: false,
  };

  let chainState = {
    sessionQuestions: [],
    currentIndex: 0,
    feedback: "",
    answered: false,
  };

  let cleanState = {
    sessionQuestions: [],
    currentIndex: 0,
    feedback: "",
    answered: false,
  };

  let schemaState = {
    sessionQuestions: [],
    currentIndex: 0,
    feedback: "",
    answered: false,
  };

  let queryState = {
    sessionQuestions: [],
    currentIndex: 0,
    feedback: "",
    answered: false,
  };

  let cryptoState = {
    sessionQuestions: [],
    currentIndex: 0,
    feedback: "",
    answered: false,
  };

  /****************************************************
   * ESCAPE ROOM â€“ 3-QUESTION / 3-LOCK SESSION
   ****************************************************/
  function startEscapeTimer() {
    const timerState = appState.timers.escape;
    if (timerState.intervalId) clearInterval(timerState.intervalId);
    timerState.secondsLeft = 45;
    timerState.intervalId = setInterval(() => {
      timerState.secondsLeft -= 1;
      renderEscapeWorld(); // re-render timer
      if (timerState.secondsLeft <= 0) {
        clearInterval(timerState.intervalId);
        timerState.intervalId = null;
        escapeState.feedback = "Timeâ€™s up. Room resets. Try again.";
        resetEscapeWorld();
      }
    }, 1000);
  }

  function handleEscapeAnswer(optionIndex) {
    if (appState.gameWon || appState.worlds.escape.completed) return;
    const currentQuestion = escapeState.sessionQuestions[escapeState.currentIndex];
    if (!currentQuestion) return;
    
    // Prevent multiple clicks on the same question
    if (escapeState.answered) return;
    escapeState.answered = true;
    
    const isCorrect = optionIndex === currentQuestion.correctIndex;

    const targetLocks = Math.min(
      escapeState.totalLocks,
      escapeState.sessionQuestions.length || escapeState.totalLocks
    );

    if (isCorrect) {
      playSound('correct');
      escapeState.locksCleared += 1;
      appState.score += 10;
      showScorePopup(10, true);
      escapeState.feedback = "âœ… Lock released. Door segment unlocked.";
      escapeState.currentIndex += 1;
      escapeState.answered = false; // Reset for next question

      if (escapeState.locksCleared >= targetLocks) {
        playSound('win');
        escapeState.feedback = "ðŸŽ‰ All locks cleared. World stabilized.";
        appState.worlds.escape.completed = true;

        if (appState.timers.escape.intervalId) {
          clearInterval(appState.timers.escape.intervalId);
          appState.timers.escape.intervalId = null;
        }
        checkGlobalWin();
      }
    } else {
      playSound('wrong');
      escapeState.feedback = "âŒ Incorrect sequence. The door re-locks slightly.";
      const penalty = 3;
      appState.score = Math.max(0, appState.score - penalty);
      showScorePopup(-penalty, false);
      escapeState.answered = false; // Allow retry on wrong answer
    }
    updateGlobalHUD();
    buildWorldButtons();
    renderEscapeWorld();
  }

  function resetEscapeWorld(skipRender) {
    escapeState.sessionQuestions = [];
    escapeState.currentIndex = 0;
    escapeState.locksCleared = 0;
    escapeState.feedback = "";
    escapeState.answered = false;
    appState.worlds.escape.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderEscapeWorld();
      startEscapeTimer();
    }
  }

  function renderEscapeWorld() {
    const container = document.getElementById("world-content");
    const timerState = appState.timers.escape;

    if (!escapeState.sessionQuestions || escapeState.sessionQuestions.length === 0) {
      escapeState.sessionQuestions = generateSessionQuestions("escape");
      escapeState.currentIndex = 0;
      escapeState.locksCleared = 0;
      escapeState.feedback = "";
    }

    const q =
      escapeState.sessionQuestions[
        Math.min(escapeState.currentIndex, escapeState.sessionQuestions.length - 1)
      ];

    document.getElementById("world-title").textContent = "AI Escape Room";
    document.getElementById("world-caption").textContent =
      "Unlock the AI control room by answering fundamentals under a soft timer.";
    document.getElementById("world-badge-primary").textContent = "AI Fundamentals";
    document.getElementById("world-badge-secondary").textContent = "Timed Â· 3 locks";

    const targetLocks = Math.min(
      escapeState.totalLocks,
      escapeState.sessionQuestions.length || escapeState.totalLocks
    );

    const locks = Array.from({ length: targetLocks }).map((_, idx) => {
      let cls = "lock-pill";
      if (idx < escapeState.locksCleared) cls += " completed";
      if (idx === escapeState.locksCleared && !appState.worlds.escape.completed) {
        cls += " current";
      }
      return `<div class="${cls}"></div>`;
    }).join("");

    const feedbackHtml = escapeState.feedback
      ? `<div class="feedback ${
          appState.worlds.escape.completed || escapeState.feedback.includes("Lock")
            ? "positive"
            : "negative"
        }">${escapeState.feedback}</div>`
      : "";

    const timerHtml = timerState.intervalId
      ? `<span class="timer">â± ${String(timerState.secondsLeft).padStart(2, "0")}s</span>`
      : `<span class="timer">â± Paused</span>`;

    const isCompleted = appState.worlds.escape.completed || appState.gameWon;
    const optionsHtml = q
      ? q.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No questions available.</div>";



    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Lock Sequence</div>
            <div class="card-sub">Answer correctly to unlock the digital door.</div>
          </div>
          <div class="locks-row">${locks}</div>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="question-text">${q ? q.question : "Session not initialized."}</div>
          <div class="help-text">Select the most accurate description.</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
        <div class="state-row">
          <div class="state-left">
            <button class="ghost-btn" id="escape-reset-btn">Reset Room</button>
            <span class="small-label">Locks cleared: ${escapeState.locksCleared} / ${
              targetLocks
            }</span>
          </div>
          <div class="state-right">
            ${timerHtml}
          </div>
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleEscapeAnswer(Number(btn.dataset.optionIndex))
        )
      );

    const resetBtn = document.getElementById("escape-reset-btn");
    resetBtn.addEventListener("click", () => {
      resetEscapeWorld();
      startEscapeTimer();
    });
  }

  /****************************************************
   * ML MODEL BUILDER â€“ 3-QUESTION SESSION
   ****************************************************/
  function handleMLDecision(optionIndex) {
    if (appState.gameWon || appState.worlds.mlbuilder.completed) return;
    if (!mlState.sessionQuestions || mlState.sessionQuestions.length === 0) return;

    // Prevent multiple clicks on the same question
    if (mlState.answered) return;
    mlState.answered = true;

    const step = mlState.sessionQuestions[
      Math.min(mlState.currentIndex, mlState.sessionQuestions.length - 1)
    ];
    const isCorrect = optionIndex === step.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 15;
      showScorePopup(15, true);
      mlState.failure = false;
      mlState.feedback = "âœ… " + step.positive;
      mlState.currentIndex += 1;
      mlState.answered = false; // Reset for next question
      if (mlState.currentIndex >= mlState.sessionQuestions.length) {
        playSound('win');
        appState.worlds.mlbuilder.completed = true;
        mlState.feedback = "ðŸŽ‰ Pipeline validated. Model is deployment-ready.";
        checkGlobalWin();
      }
    } else {
      playSound('wrong');
      mlState.failure = true;
      mlState.feedback = "âŒ " + step.negative;
      const penalty = 5;
      appState.score = Math.max(0, appState.score - penalty);
      showScorePopup(-penalty, false);
      mlState.answered = false; // Allow retry on wrong answer
    }
    updateGlobalHUD();
    buildWorldButtons();
    renderMLWorld();
  }

  function resetMLWorld(skipRender) {
    mlState.sessionQuestions = [];
    mlState.currentIndex = 0;
    mlState.failure = false;
    mlState.feedback = "";
    mlState.answered = false;
    appState.worlds.mlbuilder.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderMLWorld();
    }
  }

  function renderMLWorld() {
    const container = document.getElementById("world-content");

    if (!mlState.sessionQuestions || mlState.sessionQuestions.length === 0) {
      mlState.sessionQuestions = generateSessionQuestions("mlbuilder");
      mlState.currentIndex = 0;
      mlState.failure = false;
      mlState.feedback = "";
    }

    const stepCount = mlState.sessionQuestions.length;
    const step =
      mlState.sessionQuestions[
        Math.min(mlState.currentIndex, Math.max(stepCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "ML Model Builder";
    document.getElementById("world-caption").textContent =
      "Walk a real model lifecycle: clean, choose, regularize, and ship.";
    document.getElementById("world-badge-primary").textContent = "ML Lifecycle";
    document.getElementById("world-badge-secondary").textContent =
      "Scenario Â· Step-based";

    const pipelineStatus = mlState.failure
      ? "FAILED â€“ Metrics out of bounds"
      : appState.worlds.mlbuilder.completed
      ? "STABLE â€“ Ready for deployment"
      : "IN DESIGN â€“ Still tuning";

    const feedbackHtml = mlState.feedback
      ? `<div class="feedback ${mlState.failure ? "negative" : "positive"}">${
          mlState.feedback
        }</div>`
      : "";

    const isCompleted = appState.worlds.mlbuilder.completed;
    const optionsHtml = step
      ? step.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
                
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No ML steps configured.</div>";

    const isFinished = appState.worlds.mlbuilder.completed;

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Design Decisions</div>
            <div class="card-sub">
              Build a resilient pipeline by picking the right intervention at each step.
            </div>
          </div>
          <span class="pill-small">Question ${
            Math.min(mlState.currentIndex + 1, stepCount)
          } of ${stepCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="question-text">${
            step ? `${step.label} â€“ ${step.question}` : "Session not initialized."
          }</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
        <div class="state-row">
          <div class="state-left">
            <button class="ghost-btn" id="ml-reset-btn">Reset Pipeline</button>
            <span class="small-label">Status: ${pipelineStatus}</span>
          </div>
          <div class="state-right">
            <span class="small-label">Overfitting risk Â· ${
              mlState.failure ? "HIGH" : "CONTROLLED"
            }</span>
          </div>
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleMLDecision(Number(btn.dataset.optionIndex))
        )
      );

    document
      .getElementById("ml-reset-btn")
      .addEventListener("click", () => resetMLWorld());
  }

  /****************************************************
   * PROMPT ARENA â€“ 3-QUESTION SESSION
   ****************************************************/
  function handlePromptAnswer(optionIndex) {
    if (appState.gameWon || appState.worlds.prompt.completed) return;
    
    // Prevent multiple clicks on the same question
    if (promptState.answered) return;
    promptState.answered = true;
    if (!promptState.sessionQuestions || promptState.sessionQuestions.length === 0)
      return;

    const q =
      promptState.sessionQuestions[
        Math.min(
          promptState.currentIndex,
          Math.max(promptState.sessionQuestions.length - 1, 0)
        )
      ];
    const isCorrect = optionIndex === q.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 10;
      showScorePopup(10, true);
      promptState.feedback = "âœ… Prompt upgraded. Model output quality improves.";
      promptState.currentIndex += 1;
      if (promptState.currentIndex >= promptState.sessionQuestions.length) {
        appState.worlds.prompt.completed = true;
        promptState.feedback = "Arena cleared. Youâ€™re now prompt-ops certified.";
        checkGlobalWin();
      }
    } else {
      playSound('wrong');
      const penalty = 4;
      appState.score = Math.max(0, appState.score - penalty);
      showScorePopup(-penalty, false);
      promptState.feedback = "âŒ Ambiguous prompt. Output quality degrades.";
      promptState.answered = false; // Allow retry on wrong answer
    }
    updateGlobalHUD();
    buildWorldButtons();
    renderPromptWorld();
  }

  function resetPromptWorld(skipRender) {
    promptState.sessionQuestions = [];
    promptState.currentIndex = 0;
    promptState.feedback = "";
    promptState.answered = false;
    appState.worlds.prompt.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderPromptWorld();
    }
  }

  function renderPromptWorld() {
    const container = document.getElementById("world-content");

    if (!promptState.sessionQuestions || promptState.sessionQuestions.length === 0) {
      promptState.sessionQuestions = generateSessionQuestions("prompt");
      promptState.currentIndex = 0;
      promptState.feedback = "";
    }

    const qCount = promptState.sessionQuestions.length;
    const q =
      promptState.sessionQuestions[
        Math.min(promptState.currentIndex, Math.max(qCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "GenAI Prompt Arena";
    document.getElementById("world-caption").textContent =
      "Battle weak prompts and design instructions that ship reliable outputs.";
    document.getElementById("world-badge-primary").textContent = "Prompt Engineering";
    document.getElementById("world-badge-secondary").textContent =
      "Quality Â· Safety";

    const feedbackHtml = promptState.feedback
      ? `<div class="feedback ${
          promptState.feedback.includes("upgraded") ||
          promptState.feedback.includes("certified")
            ? "positive"
            : "negative"
        }">${promptState.feedback}</div>`
      : "";

    const isCompleted = appState.worlds.prompt.completed || appState.gameWon;
    const optionsHtml = q
      ? q.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
                
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No prompt questions configured.</div>";

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Prompt Duel</div>
            <div class="card-sub">${q ? q.title : "Session not initialized."}</div>
          </div>
          <span class="pill-small">Question ${
            Math.min(promptState.currentIndex + 1, qCount)
          } of ${qCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="question-text" style="white-space:pre-line;">${
            q ? q.question : ""
          }</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handlePromptAnswer(Number(btn.dataset.optionIndex))
        )
      );
  }

  /****************************************************
   * BLOCKCHAIN HASH HUNT â€“ 3-QUESTION SESSION
   ****************************************************/
  function handleChainAnswer(optionIndex) {
    if (appState.gameWon || appState.worlds.chain.completed) return;
    
    // Prevent multiple clicks on the same question
    if (chainState.answered) return;
    chainState.answered = true;
    
    if (!chainState.sessionQuestions || chainState.sessionQuestions.length === 0)
      return;

    const q =
      chainState.sessionQuestions[
        Math.min(chainState.currentIndex, Math.max(chainState.sessionQuestions.length - 1, 0))
      ];
    const isCorrect = optionIndex === q.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 10;
      showScorePopup(10, true);
      chainState.feedback = "âœ… Hash validated. Chain segment secured.";
      chainState.currentIndex += 1;
      chainState.answered = false; // Reset for next question
      if (chainState.currentIndex >= chainState.sessionQuestions.length) {
        playSound('win');
        appState.worlds.chain.completed = true;
        chainState.feedback = "ðŸŽ‰ All blocks verified. Ledger is stable.";
        checkGlobalWin();
      }
    } else {
      playSound('wrong');
      const penalty = 4;
      appState.score = Math.max(0, appState.score - penalty);
      showScorePopup(-penalty, false);
      chainState.feedback = "âŒ Invalid choice. Integrity alarm triggered.";
      chainState.answered = false; // Allow retry on wrong answer
    }
    updateGlobalHUD();
    buildWorldButtons();
    renderChainWorld();
  }

  function resetChainWorld(skipRender) {
    chainState.sessionQuestions = [];
    chainState.currentIndex = 0;
    chainState.feedback = "";
    chainState.answered = false;
    appState.worlds.chain.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderChainWorld();
    }
  }

  function renderChainWorld() {
    const container = document.getElementById("world-content");

    if (!chainState.sessionQuestions || chainState.sessionQuestions.length === 0) {
      chainState.sessionQuestions = generateSessionQuestions("chain");
      chainState.currentIndex = 0;
      chainState.feedback = "";
    }

    const qCount = chainState.sessionQuestions.length;
    const q =
      chainState.sessionQuestions[
        Math.min(chainState.currentIndex, Math.max(qCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "Blockchain Hash Hunt";
    document.getElementById("world-caption").textContent =
      "Validate hashes, select consensus, and keep the ledger clean.";
    document.getElementById("world-badge-primary").textContent = "Blockchain Basics";
    document.getElementById("world-badge-secondary").textContent =
      "Integrity Â· Consensus";

    const feedbackHtml = chainState.feedback
      ? `<div class="feedback ${
          chainState.feedback.includes("validated") ||
          chainState.feedback.includes("stable")
            ? "positive"
            : "negative"
        }">${chainState.feedback}</div>`
      : "";

    const sampleHash =
      "000000ab94c3f2b38174f5086e22e7b9fb305f615e7a483920c7aa12f";

    const isCompleted = appState.worlds.chain.completed || appState.gameWon;
    const optionsHtml = q
      ? q.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
                
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No blockchain questions configured.</div>";

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Hash Puzzle</div>
            <div class="card-sub">Spot invalid segments and lock the ledger.</div>
          </div>
          <span class="pill-small">Question ${
            Math.min(chainState.currentIndex + 1, qCount)
          } of ${qCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="hash-row">hash: <strong>${sampleHash}</strong></div>
          <div class="question-text">${q ? q.question : "Session not initialized."}</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleChainAnswer(Number(btn.dataset.optionIndex))
        )
      );
  }

  /****************************************************
   * DATA CLEANING NINJA â€“ 3-QUESTION SESSION
   ****************************************************/
  function handleCleanAnswer(optionIndex) {
    if (appState.gameWon || appState.worlds.clean.completed) return;
    if (!cleanState.sessionQuestions || cleanState.sessionQuestions.length === 0)
      return;

    const q =
      cleanState.sessionQuestions[
        Math.min(cleanState.currentIndex, Math.max(cleanState.sessionQuestions.length - 1, 0))
      ];
    const isCorrect = optionIndex === q.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 10;
      showScorePopup(10, true);
      cleanState.feedback = "âœ… Dataset quality improved. Downstream models thank you.";
      cleanState.currentIndex += 1;
      if (cleanState.currentIndex >= cleanState.sessionQuestions.length) {
        appState.worlds.clean.completed = true;
        cleanState.feedback = "All key issues resolved. Dataset is production-grade.";
        checkGlobalWin();
      }
    } else {
      appState.score = Math.max(0, appState.score - 3);
      playSound('wrong');
      showScorePopup(-3, false);
      cleanState.feedback = "Dirty data flows downstream. Youâ€™ve created debt.";
    }
    updateGlobalHUD();
    renderCleanWorld();
  }

  function resetCleanWorld(skipRender) {
    cleanState.sessionQuestions = [];
    cleanState.currentIndex = 0;
    cleanState.feedback = "";
    cleanState.answered = false;
    appState.worlds.clean.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderCleanWorld();
    }
  }

  function renderCleanWorld() {
    const container = document.getElementById("world-content");

    if (!cleanState.sessionQuestions || cleanState.sessionQuestions.length === 0) {
      cleanState.sessionQuestions = generateSessionQuestions("clean");
      cleanState.currentIndex = 0;
      cleanState.feedback = "";
    }

    const qCount = cleanState.sessionQuestions.length;
    const q =
      cleanState.sessionQuestions[
        Math.min(cleanState.currentIndex, Math.max(qCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "Data Cleaning Ninja";
    document.getElementById("world-caption").textContent =
      "Neutralize messy datasets before they reach production pipelines.";
    document.getElementById("world-badge-primary").textContent = "Data Quality";
    document.getElementById("world-badge-secondary").textContent =
      "Dedupe Â· Normalize";

    const feedbackHtml = cleanState.feedback
      ? `<div class="feedback ${
          cleanState.feedback.includes("improved") ||
          cleanState.feedback.includes("production-grade")
            ? "positive"
            : "negative"
        }">${cleanState.feedback}</div>`
      : "";

    const isCompleted = appState.worlds.clean.completed || appState.gameWon;
    const optionsHtml = q
      ? q.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
                
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No cleaning questions configured.</div>";

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Cleaning Task</div>
            <div class="card-sub">Pick the right action on a messy dataset.</div>
          </div>
          <span class="pill-small">Question ${
            Math.min(cleanState.currentIndex + 1, qCount)
          } of ${qCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="question-text">${q ? q.question : "Session not initialized."}</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleCleanAnswer(Number(btn.dataset.optionIndex))
        )
      );
  }

  /****************************************************
   * SCHEMA VALIDATOR LAB â€“ 3-QUESTION SESSION
   ****************************************************/
  function handleSchemaAnswer(optionIndex) {
    if (appState.gameWon || appState.worlds.schema.completed) return;
    
    // Prevent multiple clicks on the same question
    if (schemaState.answered) return;
    schemaState.answered = true;
    
    if (!schemaState.sessionQuestions || schemaState.sessionQuestions.length === 0)
      return;

    const q =
      schemaState.sessionQuestions[
        Math.min(schemaState.currentIndex, Math.max(schemaState.sessionQuestions.length - 1, 0))
      ];
    const isCorrect = optionIndex === q.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 10;
      showScorePopup(10, true);
      schemaState.feedback =
        "âœ… Schema check passes. Application-layer errors drop immediately.";
      schemaState.currentIndex += 1;
      schemaState.answered = false; // Reset for next question
      if (schemaState.currentIndex >= schemaState.sessionQuestions.length) {
        playSound('win');
        appState.worlds.schema.completed = true;
        schemaState.feedback = "ðŸŽ‰ All constraints aligned. Schema lab stabilized.";
        checkGlobalWin();
      }
    } else {
      playSound('wrong');
      appState.score = Math.max(0, appState.score - 3);
      showScorePopup(-3, false);
      schemaState.feedback =
        "âŒ Hidden schema drift introduced. Production incidents spike.";
      schemaState.answered = false; // Allow retry on wrong answer
    }
    updateGlobalHUD();
    buildWorldButtons();
    renderSchemaWorld();
  }

  function resetSchemaWorld(skipRender) {
    schemaState.sessionQuestions = [];
    schemaState.currentIndex = 0;
    schemaState.feedback = "";
    appState.worlds.schema.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderSchemaWorld();
    }
  }

  function renderSchemaWorld() {
    const container = document.getElementById("world-content");

    if (!schemaState.sessionQuestions || schemaState.sessionQuestions.length === 0) {
      schemaState.sessionQuestions = generateSessionQuestions("schema");
      schemaState.currentIndex = 0;
      schemaState.feedback = "";
    }

    const qCount = schemaState.sessionQuestions.length;
    const q =
      schemaState.sessionQuestions[
        Math.min(schemaState.currentIndex, Math.max(qCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "Schema Validator Lab";
    document.getElementById("world-caption").textContent =
      "Catch mismatches between expectations and reality before they hit production.";
    document.getElementById("world-badge-primary").textContent = "Data Contracts";
    document.getElementById("world-badge-secondary").textContent =
      "PK/FK Â· Nullability";

    const feedbackHtml = schemaState.feedback
      ? `<div class="feedback ${
          schemaState.feedback.includes("passes") ||
          schemaState.feedback.includes("stabilized")
            ? "positive"
            : "negative"
        }">${schemaState.feedback}</div>`
      : "";

    const isCompleted = appState.worlds.schema.completed || appState.gameWon;
    const optionsHtml = q
      ? q.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
                
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No schema questions configured.</div>";

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Schema Check</div>
            <div class="card-sub">Identify the constraint that is being violated.</div>
          </div>
          <span class="pill-small">Question ${
            Math.min(schemaState.currentIndex + 1, qCount)
          } of ${qCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="question-text">${q ? q.question : "Session not initialized."}</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleSchemaAnswer(Number(btn.dataset.optionIndex))
        )
      );
  }

  /****************************************************
   * QUERY OPTIMIZER RACE â€“ 3-QUESTION SESSION
   ****************************************************/
  function handleQueryAnswer(optionIndex) {    if (appState.gameWon || appState.worlds.query.completed) return;
    if (!queryState.sessionQuestions || queryState.sessionQuestions.length === 0)
      return;

    const q =
      queryState.sessionQuestions[
        Math.min(queryState.currentIndex, Math.max(queryState.sessionQuestions.length - 1, 0))
      ];
    const isCorrect = optionIndex === q.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 12;
      showScorePopup(12, true);
      queryState.feedback = "âœ… Boost! Execution plan streamlined.";
      queryState.currentIndex += 1;
      if (queryState.currentIndex >= queryState.sessionQuestions.length) {
        appState.worlds.query.completed = true;
        queryState.feedback = "Race won. Query fleet fully optimized.";
        checkGlobalWin();
      }
    } else {
      appState.score = Math.max(0, appState.score - 5);     showScorePopup(-5, false);     queryState.feedback = "Engine stalls. The optimizer canâ€™t rescue a bad pattern.";
    }
    updateGlobalHUD();
    renderQueryWorld();
  }

  function resetQueryWorld(skipRender) {
    queryState.sessionQuestions = [];
    queryState.currentIndex = 0;
    queryState.feedback = "";
    queryState.answered = false;
    appState.worlds.query.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderQueryWorld();
    }
  }

  function renderQueryWorld() {
    const container = document.getElementById("world-content");

    if (!queryState.sessionQuestions || queryState.sessionQuestions.length === 0) {
      queryState.sessionQuestions = generateSessionQuestions("query");
      queryState.currentIndex = 0;
      queryState.feedback = "";
    }

    const qCount = queryState.sessionQuestions.length;
    const q =
      queryState.sessionQuestions[
        Math.min(queryState.currentIndex, Math.max(qCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "Query Optimizer Race";
    document.getElementById("world-caption").textContent =
      "Pick the faster query under race conditions and monitor the plan.";
    document.getElementById("world-badge-primary").textContent = "SQL Performance";
    document.getElementById("world-badge-secondary").textContent =
      "Indexes Â· Joins";

    const feedbackHtml = queryState.feedback
      ? `<div class="feedback ${
          queryState.feedback.includes("Boost") ||
          queryState.feedback.includes("Race won")
            ? "positive"
            : "negative"
        }">${queryState.feedback}</div>`
      : "";

      const isCompleted = appState.worlds.query.completed || appState.gameWon;
      const optionsHtml = q
        ? q.options
            .map(
              (opt, idx) => `
                <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                  <div>
                    <div><span class="option-label">Q${idx + 1}.</span> ${opt}</div>
                    <div class="small-label">${q.labels && q.labels[idx] ? q.labels[idx] : ""}</div>
                  </div>
                </button>
              `
            )
            .join("")
        : "<div class='small-label'>No query questions configured.</div>";

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Race Segment</div>
            <div class="card-sub">Two queries. One leaderboard.</div>
          </div>
          <span class="pill-small">Question ${
            Math.min(queryState.currentIndex + 1, qCount)
          } of ${qCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="question-text">${q ? q.question : "Session not initialized."}</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleQueryAnswer(Number(btn.dataset.optionIndex))
        )
      );
  }

  /****************************************************
   * CRYPTO-FOR-DATA PUZZLE â€“ 3-QUESTION SESSION
   ****************************************************/
  function handleCryptoAnswer(optionIndex) {
    if (appState.gameWon || appState.worlds.crypto.completed) return;
    
    // Prevent multiple clicks on the same question
    if (cryptoState.answered) return;
    cryptoState.answered = true;
    
    if (!cryptoState.sessionQuestions || cryptoState.sessionQuestions.length === 0)
      return;

    const q =
      cryptoState.sessionQuestions[
        Math.min(cryptoState.currentIndex, Math.max(cryptoState.sessionQuestions.length - 1, 0))
      ];
    const isCorrect = optionIndex === q.correctIndex;
    if (isCorrect) {
      playSound('correct');
      appState.score += 10;
      showScorePopup(10, true);
      cryptoState.feedback = "âœ… Cipher cracked. Message integrity restored.";
      cryptoState.currentIndex += 1;
      cryptoState.answered = false; // Reset for next question
      if (cryptoState.currentIndex >= cryptoState.sessionQuestions.length) {
        playSound('win');
        appState.worlds.crypto.completed = true;
        cryptoState.feedback = "ðŸŽ‰ All crypto puzzles cleared. Data vault is secure.";
        checkGlobalWin();
      }
    } else {
      playSound('wrong');
      appState.score = Math.max(0, appState.score - 4);
      showScorePopup(-4, false);
      cryptoState.feedback =
        "âŒ Incorrect. The attacker gains signal on your mental model.";
      cryptoState.answered = false; // Allow retry on wrong answer
    }
    updateGlobalHUD();
    buildWorldButtons();
    renderCryptoWorld();
  }

  function resetCryptoWorld(skipRender) {
    cryptoState.sessionQuestions = [];
    cryptoState.currentIndex = 0;
    cryptoState.feedback = "";
    appState.worlds.crypto.completed = false;
    if (!skipRender) {
      buildWorldButtons();
      renderCryptoWorld();
    }
  }

  function renderCryptoWorld() {
    const container = document.getElementById("world-content");

    if (!cryptoState.sessionQuestions || cryptoState.sessionQuestions.length === 0) {
      cryptoState.sessionQuestions = generateSessionQuestions("crypto");
      cryptoState.currentIndex = 0;
      cryptoState.feedback = "";
    }

    const qCount = cryptoState.sessionQuestions.length;
    const q =
      cryptoState.sessionQuestions[
        Math.min(cryptoState.currentIndex, Math.max(qCount - 1, 0))
      ];

    document.getElementById("world-title").textContent = "Crypto-for-Data Puzzle";
    document.getElementById("world-caption").textContent =
      "Play with basic ciphers and security concepts to keep the data vault intact.";
    document.getElementById("world-badge-primary").textContent = "Crypto Basics";
    document.getElementById("world-badge-secondary").textContent =
      "Keys Â· Hashes";

    const feedbackHtml = cryptoState.feedback
      ? `<div class="feedback ${
          cryptoState.feedback.includes("cracked") ||
          cryptoState.feedback.includes("secure")
            ? "positive"
            : "negative"
        }">${cryptoState.feedback}</div>`
      : "";

    const toyCipher = "KHOOR â†’ HELLO (Caesar +3)";

    const isCompleted = appState.worlds.crypto.completed || appState.gameWon;
    const optionsHtml = q
      ? q.options
          .map(
            (opt, idx) => `
              <button class="option-btn ${isCompleted ? 'disabled' : ''}" data-option-index="${idx}">
                <div><span class="option-label">${String.fromCharCode(
                  65 + idx
                )}.</span> ${opt}</div>
                
              </button>
            `
          )
          .join("")
      : "<div class='small-label'>No crypto questions configured.</div>";

    container.innerHTML = `
      <div class="card">
        <div class="card-header-row">
          <div>
            <div class="card-title">Crypto Question</div>
            <div class="card-sub">Lock in the correct concept.</div>
          </div>
          <span class="pill-small">Question ${
            Math.min(cryptoState.currentIndex + 1, qCount)
          } of ${qCount}</span>
        </div>
        <div class="divider"></div>
        <div class="question-area">
          <div class="hash-row">${toyCipher}</div>
          <div class="question-text">${q ? q.question : "Session not initialized."}</div>
          <div class="options-list">
            ${optionsHtml}
          </div>
          ${feedbackHtml}
        </div>
      </div>
    `;

    container
      .querySelectorAll(".option-btn")
      .forEach(btn =>
        btn.addEventListener("click", () =>
          handleCryptoAnswer(Number(btn.dataset.optionIndex))
        )
      );
  }

  /****************************************************
   * WORLD ROUTING
   ****************************************************/
  function moveToWorld(worldId) {
    // Stop escape timer if switching away from escape room
    if (appState.currentWorldId === "escape" && worldId !== "escape") {
      if (appState.timers.escape.intervalId) {
        clearInterval(appState.timers.escape.intervalId);
        appState.timers.escape.intervalId = null;
      }
    }
    
    appState.currentWorldId = worldId;
    markWorldButtonActive(worldId);
    updateGlobalHUD();

    switch (worldId) {
      case "escape":
        renderEscapeWorld();
        if (!appState.worlds.escape.completed) {
          startEscapeTimer();
        }
        break;
      case "mlbuilder":
        renderMLWorld();
        break;
      case "prompt":
        renderPromptWorld();
        break;
      case "chain":
        renderChainWorld();
        break;
      case "clean":
        renderCleanWorld();
        break;
      case "schema":
        renderSchemaWorld();
        break;
      case "query":
        renderQueryWorld();
        break;
      case "crypto":
        renderCryptoWorld();
        break;
      default:
        renderEscapeWorld();
        if (!appState.worlds.escape.completed) {
          startEscapeTimer();
        }
    }
  }

  /****************************************************
   * FULL GAME RESET â€“ AFTER 3 WORLDS CLEARED
   ****************************************************/
  function resetFullGame() {
    // Reset global score and win flag
    appState.score = 0;
    appState.gameWon = false;

    // Reset world meta
    Object.keys(appState.worlds).forEach(id => {
      appState.worlds[id].completed = false;
    });

    // Reset timer
    if (appState.timers.escape.intervalId) {
      clearInterval(appState.timers.escape.intervalId);
      appState.timers.escape.intervalId = null;
    }
    appState.timers.escape.secondsLeft = 45;

    // Reset world states
    resetEscapeWorld(true);
    resetMLWorld(true);
    resetPromptWorld(true);
    resetChainWorld(true);
    resetCleanWorld(true);
    resetSchemaWorld(true);
    resetQueryWorld(true);
    resetCryptoWorld(true);

    buildWorldButtons();
    updateGlobalHUD();
    hideWinModal();
    moveToWorld("escape");
  }

  /****************************************************
   * BOOTSTRAP
   ****************************************************/
  async function bootstrap() {
    // Load questions from CSV first
    await loadQuestionsFromCSV();
    
    buildWorldButtons();
    updateGlobalHUD();
    moveToWorld("escape");

    const winResetBtn = document.getElementById("win-reset-btn");
    if (winResetBtn) {
      winResetBtn.addEventListener("click", resetFullGame);
    }
  }

  /****************************************************
   * SOUND EFFECTS - Web Audio API (No Installation!)
   ****************************************************/
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();

  function playSound(type) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    switch(type) {
      case 'correct':
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.exponentialRampToValueAtTime(783.99, audioContext.currentTime + 0.1); // G5
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
        break;
      
      case 'wrong':
        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        break;
      
      case 'win':
        // Victory fanfare
        [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
          gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
          osc.start(audioContext.currentTime + i * 0.15);
          osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
        });
        break;
      
      case 'click':
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.05);
        break;
      
      case 'hover':
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.03);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.03);
        break;
    }
  }

  // Add sound to all buttons
  document.addEventListener('click', (e) => {
    if (e.target.matches('button') || e.target.closest('button')) {
      playSound('click');
    }
  });

  // Add hover sound to option buttons
  document.addEventListener('mouseover', (e) => {
    if (e.target.closest('.option-btn') || e.target.closest('.world-btn')) {
      playSound('hover');
    }
  });

  /****************************************************
   * PARTICLE EFFECTS FOR CORRECT ANSWERS
   ****************************************************/
  function createParticles(x, y) {
    const colors = ['#4ade80', '#22c55e', '#a78bfa', '#fb923c', '#fbbf24'];
    for (let i = 0; i < 15; i++) {
      const particle = document.createElement('div');
      particle.style.position = 'fixed';
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      particle.style.width = '8px';
      particle.style.height = '8px';
      particle.style.borderRadius = '50%';
      particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      particle.style.pointerEvents = 'none';
      particle.style.zIndex = '9999';
      particle.style.boxShadow = '0 0 10px currentColor';
      
      document.body.appendChild(particle);
      
      const angle = (Math.PI * 2 * i) / 15;
      const velocity = 100 + Math.random() * 100;
      const vx = Math.cos(angle) * velocity;
      const vy = Math.sin(angle) * velocity;
      
      let posX = x;
      let posY = y;
      let opacity = 1;
      
      const animate = () => {
        posX += vx * 0.016;
        posY += vy * 0.016 + 2;
        opacity -= 0.02;
        
        particle.style.left = posX + 'px';
        particle.style.top = posY + 'px';
        particle.style.opacity = opacity;
        
        if (opacity > 0) {
          requestAnimationFrame(animate);
        } else {
          particle.remove();
        }
      };
      
      requestAnimationFrame(animate);
    }
  }

  // Add particle effect on correct answers and shake on wrong
  document.addEventListener('click', (e) => {
    if (e.target.closest('.option-btn')) {
      setTimeout(() => {
        const feedbackPositive = document.querySelector('.feedback.positive');
        const feedbackNegative = document.querySelector('.feedback.negative');
        
        if (feedbackPositive) {
          const rect = e.target.getBoundingClientRect();
          createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2);
          
          // Add bounce to score
          const scoreDisplay = document.getElementById('score-display');
          if (scoreDisplay) {
            scoreDisplay.classList.add('bounce-animation');
            setTimeout(() => scoreDisplay.classList.remove('bounce-animation'), 600);
          }
        }
        
        if (feedbackNegative) {
          // Shake the world-main container
          const worldMain = document.querySelector('.world-main');
          if (worldMain) {
            worldMain.style.animation = 'none';
            setTimeout(() => {
              worldMain.style.animation = 'shake 0.5s ease';
              setTimeout(() => {
                worldMain.style.animation = 'slide-up 0.6s ease';
              }, 500);
            }, 10);
          }
        }
      }, 100);
    }
  });

  bootstrap();
</script>
</body>
</html>











